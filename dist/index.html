<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M&J Social | HoostHubs</title>
    
    <!-- Next.js Style CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN version) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF0055',
                        'primary-dark': '#CC0044',
                        secondary: '#00E5FF',
                        accent: '#9D4EDD',
                        success: '#00CC88',
                        warning: '#FFAA00',
                        danger: '#FF3333',
                        dark: {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a3a3a3',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom CSS for advanced features */
        :root {
            --primary: #FF0055;
            --secondary: #00E5FF;
            --accent: #9D4EDD;
            --dark: #000000;
            --card: #121212;
            --glass: rgba(255, 255, 255, 0.05);
        }
        
        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Shimmer effect */
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.1) 20%,
                rgba(255, 255, 255, 0.3) 60%,
                rgba(255, 255, 255, 0)
            );
            animation: shimmer 2s infinite;
        }
        
        /* Custom animations */
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        /* Video player custom styles */
        .video-container {
            position: relative;
            padding-bottom: 177.78%; /* 9:16 aspect ratio */
            height: 0;
            overflow: hidden;
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Story ring animation */
        .story-ring {
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            padding: 2px;
            border-radius: 50%;
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 11px;
            background: var(--primary);
            color: white;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        /* Message bubble */
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }
        
        .message-bubble.sent {
            background: var(--primary);
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }
        
        .message-bubble.received {
            background: var(--card);
            border-bottom-left-radius: 4px;
        }
        
        /* Floating action button */
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 4px 20px rgba(255, 0, 85, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 0, 85, 0.4);
        }
        
        /* Tab underline animation */
        .tab-underline {
            position: relative;
        }
        
        .tab-underline::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .tab-underline.active::after {
            transform: scaleX(1);
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-dark-950 text-white font-sans overflow-x-hidden">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-dark-950 z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative">
            <div class="w-20 h-20 rounded-full border-4 border-dark-800 border-t-primary animate-spin-slow"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-2xl font-black gradient-text">M&J</div>
            </div>
        </div>
        <div class="mt-6 text-dark-400 text-sm font-medium animate-pulse">Connexion √† HoostHubs...</div>
        <div class="mt-2 text-xs text-dark-500">https://hoosthubs-g.onrender.com</div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="fixed inset-0 bg-gradient-to-br from-dark-950 via-dark-900 to-dark-950 z-40 hidden">
        <div class="container mx-auto px-4 h-full flex items-center justify-center">
            <div class="w-full max-w-md">
                <!-- Logo -->
                <div class="text-center mb-8">
                    <div class="text-5xl font-black gradient-text inline-block mb-2">M&J</div>
                    <div class="text-dark-400 text-sm font-medium">Plateforme Sociale HoostHubs</div>
                </div>
                
                <!-- Auth Card -->
                <div class="glass rounded-2xl p-8 shadow-2xl animate-fade-in">
                    <!-- Tabs -->
                    <div class="flex mb-6 bg-dark-800 rounded-xl p-1">
                        <button id="loginTab" class="flex-1 py-2 rounded-lg font-semibold transition-colors bg-primary text-white">
                            Connexion
                        </button>
                        <button id="registerTab" class="flex-1 py-2 rounded-lg font-semibold transition-colors text-dark-300 hover:text-white">
                            Inscription
                        </button>
                    </div>
                    
                    <!-- Login Form -->
                    <div id="loginForm">
                        <div class="mb-4">
                            <label class="block text-dark-300 text-sm font-medium mb-2">Nom d'utilisateur</label>
                            <input type="text" id="loginUsername" 
                                   class="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"
                                   placeholder="Entrez votre username" value="test">
                        </div>
                        <div class="mb-6">
                            <label class="block text-dark-300 text-sm font-medium mb-2">Mot de passe</label>
                            <input type="password" id="loginPassword" 
                                   class="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"
                                   placeholder="Votre mot de passe" value="test123">
                        </div>
                        <button onclick="login()" 
                                class="w-full bg-gradient-to-r from-primary to-primary-dark text-white font-semibold py-3 rounded-xl hover:opacity-90 transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-sign-in-alt"></i>
                            Se connecter
                        </button>
                    </div>
                    
                    <!-- Register Form -->
                    <div id="registerForm" class="hidden">
                        <div class="mb-4">
                            <label class="block text-dark-300 text-sm font-medium mb-2">Nom d'utilisateur</label>
                            <input type="text" id="registerUsername" 
                                   class="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"
                                   placeholder="Choisissez un username">
                        </div>
                        <div class="mb-4">
                            <label class="block text-dark-300 text-sm font-medium mb-2">Mot de passe</label>
                            <input type="password" id="registerPassword" 
                                   class="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"
                                   placeholder="Minimum 6 caract√®res">
                        </div>
                        <div class="mb-6">
                            <label class="block text-dark-300 text-sm font-medium mb-2">Confirmer le mot de passe</label>
                            <input type="password" id="registerConfirm" 
                                   class="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"
                                   placeholder="Retapez votre mot de passe">
                        </div>
                        <button onclick="register()" 
                                class="w-full bg-gradient-to-r from-primary to-primary-dark text-white font-semibold py-3 rounded-xl hover:opacity-90 transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-user-plus"></i>
                            Cr√©er mon compte
                        </button>
                    </div>
                    
                    <!-- Forgot Password -->
                    <div class="mt-6 text-center">
                        <a href="#" onclick="showForgotPassword()" class="text-dark-400 hover:text-primary text-sm transition">
                            Mot de passe oubli√© ?
                        </a>
                    </div>
                    
                    <!-- Server Status -->
                    <div class="mt-6 pt-6 border-t border-dark-800">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-dark-400">Serveur:</span>
                            <span id="serverStatus" class="flex items-center gap-1">
                                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                <span>D√©connect√©</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Welcome Message -->
                <div class="mt-8 text-center text-dark-400 text-sm">
                    <p>Bienvenue sur la plateforme sociale M&J</p>
                    <p class="mt-1">Connect√© √† <span class="text-primary">https://hoosthubs-g.onrender.com</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 glass border-b border-dark-800 z-30">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <!-- Left: Logo & Title -->
                    <div class="flex items-center gap-3">
                        <div class="text-2xl font-black gradient-text">M&J</div>
                        <div class="text-sm text-dark-400 hidden md:block">HoostHubs Social</div>
                    </div>
                    
                    <!-- Center: Page Title -->
                    <div class="flex-1 max-w-xl">
                        <h1 id="pageTitle" class="text-lg font-bold text-center">Pour toi</h1>
                    </div>
                    
                    <!-- Right: Actions -->
                    <div class="flex items-center gap-3">
                        <!-- Search Button -->
                        <button onclick="toggleSearch()" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-dark-800 transition">
                            <i class="fas fa-search text-dark-300"></i>
                        </button>
                        
                        <!-- Notifications -->
                        <div class="relative">
                            <button onclick="toggleNotifications()" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-dark-800 transition">
                                <i class="fas fa-bell text-dark-300"></i>
                                <span id="notificationCount" class="notification-badge hidden">0</span>
                            </button>
                        </div>
                        
                        <!-- User Menu -->
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="w-10 h-10 rounded-full overflow-hidden border-2 border-primary">
                                <img id="userAvatar" src="" alt="Avatar" class="w-full h-full object-cover">
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div id="searchBar" class="hidden py-4">
                    <div class="relative">
                        <input type="text" id="globalSearch" 
                               class="w-full bg-dark-800 border border-dark-700 rounded-xl pl-12 pr-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition"
                               placeholder="Rechercher des vid√©os, utilisateurs, hashtags...">
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2">
                            <i class="fas fa-search text-dark-500"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1">
            <!-- Stories -->
            <div id="storiesSection" class="py-4 border-b border-dark-800 hidden">
                <div class="container mx-auto px-4">
                    <div class="flex gap-4 overflow-x-auto pb-2">
                        <!-- Stories will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Video Feed -->
            <div id="feedContainer" class="min-h-screen">
                <!-- Videos will be loaded here -->
            </div>

            <!-- Explore Page -->
            <div id="explorePage" class="hidden p-4">
                <div class="container mx-auto">
                    <h2 class="text-2xl font-bold mb-6">Explorer</h2>
                    
                    <!-- Categories Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                        <!-- Categories will be loaded here -->
                    </div>
                    
                    <!-- Trending Videos -->
                    <div id="trendingVideos"></div>
                </div>
            </div>

            <!-- Messages Page -->
            <div id="messagesPage" class="hidden">
                <div class="container mx-auto px-4 py-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">Messages</h2>
                        <button onclick="startNewChat()" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-dark-800 transition">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    
                    <div id="conversationsList">
                        <!-- Conversations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="hidden">
                <!-- Profile Header -->
                <div class="relative">
                    <div class="h-48 bg-gradient-to-r from-primary/20 to-secondary/20"></div>
                    <div class="container mx-auto px-4 relative -top-12">
                        <div class="flex items-end justify-between">
                            <!-- Avatar & Info -->
                            <div class="flex items-end gap-4">
                                <div class="relative">
                                    <img id="profileAvatar" src="" alt="" class="w-32 h-32 rounded-full border-4 border-dark-950 object-cover">
                                    <button onclick="changeAvatar()" class="absolute bottom-2 right-2 w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                        <i class="fas fa-camera text-xs"></i>
                                    </button>
                                </div>
                                <div class="pb-4">
                                    <h1 id="profileUsername" class="text-2xl font-bold"></h1>
                                    <p id="profileBio" class="text-dark-400 mt-1"></p>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-2 pb-4">
                                <button id="followButton" class="px-6 py-2 bg-primary text-white rounded-lg font-semibold hover:opacity-90 transition">
                                    Suivre
                                </button>
                                <button onclick="openChat()" class="w-10 h-10 glass rounded-lg flex items-center justify-center hover:bg-dark-800 transition">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Stats -->
                <div class="container mx-auto px-4 -mt-8 mb-8">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="glass rounded-xl p-4 text-center">
                            <div id="profileVideosCount" class="text-2xl font-bold">0</div>
                            <div class="text-sm text-dark-400 mt-1">Vid√©os</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center">
                            <div id="profileFollowersCount" class="text-2xl font-bold">0</div>
                            <div class="text-sm text-dark-400 mt-1">Abonn√©s</div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center">
                            <div id="profileFollowingCount" class="text-2xl font-bold">0</div>
                            <div class="text-sm text-dark-400 mt-1">Abonnements</div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Videos -->
                <div class="container mx-auto px-4">
                    <div class="flex border-b border-dark-800 mb-6">
                        <button class="tab-underline active px-4 py-2 font-semibold">Vid√©os</button>
                        <button class="tab-underline px-4 py-2 font-semibold" onclick="loadLikedVideos()">J'aime</button>
                    </div>
                    
                    <div id="profileVideosGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- User's videos will be loaded here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="sticky bottom-0 glass border-t border-dark-800 py-2 z-30">
            <div class="container mx-auto px-4">
                <div class="flex justify-around items-center">
                    <button onclick="showPage('home')" class="flex flex-col items-center p-2 rounded-lg transition-colors text-primary">
                        <i class="fas fa-home text-xl mb-1"></i>
                        <span class="text-xs font-medium">Accueil</span>
                    </button>
                    
                    <button onclick="showPage('explore')" class="flex flex-col items-center p-2 rounded-lg transition-colors text-dark-400 hover:text-white">
                        <i class="fas fa-compass text-xl mb-1"></i>
                        <span class="text-xs font-medium">Explorer</span>
                    </button>
                    
                    <!-- Create Button -->
                    <div class="relative -top-4">
                        <button onclick="showUploadModal()" class="fab">
                            <i class="fas fa-plus text-white text-xl"></i>
                        </button>
                    </div>
                    
                    <button onclick="showPage('messages')" class="flex flex-col items-center p-2 rounded-lg transition-colors text-dark-400 hover:text-white">
                        <i class="fas fa-comment-dots text-xl mb-1"></i>
                        <span class="text-xs font-medium">Messages</span>
                    </button>
                    
                    <button onclick="showPage('profile')" class="flex flex-col items-center p-2 rounded-lg transition-colors text-dark-400 hover:text-white">
                        <i class="fas fa-user text-xl mb-1"></i>
                        <span class="text-xs font-medium">Profil</span>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="videoUpload" accept="video/*" class="hidden">
    <input type="file" id="imageUpload" accept="image/*" class="hidden">

    <!-- JavaScript -->
    <script>
        // Configuration
        const API_BASE_URL = 'https://hoosthubs-g.onrender.com';
        const WS_URL = 'wss://hoosthubs-g.onrender.com/ws';
        
        // Application State
        let state = {
            token: localStorage.getItem('mj_token'),
            user: null,
            currentPage: 'home',
            videos: [],
            stories: [],
            conversations: [],
            notifications: [],
            ws: null,
            isOnline: false,
            unreadNotifications: 0
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing M&J Social App...');
            console.log('Connecting to:', API_BASE_URL);
            
            // Test server connection
            await checkServerStatus();
            
            // Setup auth tabs
            setupAuthTabs();
            
            // Check if user is already logged in
            if (state.token) {
                try {
                    const user = await fetchWithAuth('/api/users/me');
                    if (user) {
                        state.user = user;
                        initializeApp();
                    } else {
                        showAuthScreen();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    showAuthScreen();
                }
            } else {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        showAuthScreen();
                    }, 500);
                }, 1500);
            }
        });

        // Server Status Check
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                const statusEl = document.getElementById('serverStatus');
                if (data.status === 'healthy') {
                    statusEl.innerHTML = `
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="text-green-500">Connect√©</span>
                    `;
                    state.isOnline = true;
                } else {
                    statusEl.innerHTML = `
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        <span class="text-red-500">D√©connect√©</span>
                    `;
                    state.isOnline = false;
                }
            } catch (error) {
                console.error('Server check failed:', error);
                document.getElementById('serverStatus').innerHTML = `
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    <span class="text-red-500">Hors ligne</span>
                `;
                state.isOnline = false;
            }
        }

        // Setup Auth Tabs
        function setupAuthTabs() {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            loginTab.addEventListener('click', () => {
                loginTab.classList.add('bg-primary', 'text-white');
                loginTab.classList.remove('text-dark-300');
                registerTab.classList.remove('bg-primary', 'text-white');
                registerTab.classList.add('text-dark-300');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            });

            registerTab.addEventListener('click', () => {
                registerTab.classList.add('bg-primary', 'text-white');
                registerTab.classList.remove('text-dark-300');
                loginTab.classList.remove('bg-primary', 'text-white');
                loginTab.classList.add('text-dark-300');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            });
        }

        // Show Auth Screen
        function showAuthScreen() {
            const authScreen = document.getElementById('authScreen');
            authScreen.classList.remove('hidden');
            setTimeout(() => {
                authScreen.style.opacity = '1';
            }, 10);
        }

        // Authentication
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            showToast('Connexion en cours...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    state.token = data.access_token;
                    localStorage.setItem('mj_token', state.token);
                    
                    // Get user profile
                    const user = await fetchWithAuth('/api/users/me');
                    if (user) {
                        state.user = user;
                        showToast('Connexion r√©ussie !', 'success');
                        initializeApp();
                    }
                } else {
                    showToast(data.detail || 'Identifiants incorrects', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Erreur de connexion au serveur', 'error');
            }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            
            if (!username || !password || !confirm) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }
            
            if (password !== confirm) {
                showToast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            showToast('Cr√©ation du compte...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    state.token = data.access_token;
                    localStorage.setItem('mj_token', state.token);
                    showToast('Compte cr√©√© avec succ√®s !', 'success');
                    location.reload();
                } else {
                    showToast(data.detail || "Erreur lors de l'inscription", 'error');
                }
            } catch (error) {
                console.error('Register error:', error);
                showToast('Erreur de connexion au serveur', 'error');
            }
        }

        function showForgotPassword() {
            showToast('Fonctionnalit√© bient√¥t disponible', 'info');
        }

        // Initialize Main App
        function initializeApp() {
            // Hide auth screen
            const authScreen = document.getElementById('authScreen');
            authScreen.style.opacity = '0';
            setTimeout(() => {
                authScreen.classList.add('hidden');
            }, 500);
            
            // Show main app
            document.getElementById('app').classList.remove('hidden');
            
            // Update user avatar
            if (state.user && state.user.avatar_url) {
                document.getElementById('userAvatar').src = state.user.avatar_url;
                document.getElementById('profileAvatar').src = state.user.avatar_url;
            }
            
            // Load initial data
            loadHomeFeed();
            loadNotifications();
            
            // Setup WebSocket
            setupWebSocket();
        }

        // API Helper
        async function fetchWithAuth(endpoint, options = {}) {
            if (!state.token) return null;
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${state.token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...defaultOptions,
                    ...options
                });
                
                if (response.status === 401) {
                    // Token expired
                    localStorage.removeItem('mj_token');
                    state.token = null;
                    showAuthScreen();
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return null;
            }
        }

        // WebSocket Setup
        function setupWebSocket() {
            if (!state.user) return;
            
            try {
                state.ws = new WebSocket(`${WS_URL}/${state.user.id}`);
                
                state.ws.onopen = () => {
                    console.log('WebSocket connected');
                    state.isOnline = true;
                };
                
                state.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                state.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    state.isOnline = false;
                    // Try to reconnect after 5 seconds
                    setTimeout(setupWebSocket, 5000);
                };
                
                state.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('WebSocket setup failed:', error);
            }
        }

        // WebSocket Message Handler
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'notification':
                    handleNewNotification(data);
                    break;
                case 'message':
                    handleNewMessage(data);
                    break;
                case 'like':
                    handleVideoLike(data);
                    break;
            }
        }

        // Load Home Feed
        async function loadHomeFeed() {
            showLoadingSkeleton('feedContainer', 3);
            
            try {
                const videos = await fetchWithAuth('/api/videos/feed');
                if (videos) {
                    state.videos = videos;
                    renderVideoFeed(videos);
                }
            } catch (error) {
                console.error('Error loading feed:', error);
                document.getElementById('feedContainer').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-wifi-slash text-4xl text-dark-600 mb-4"></i>
                        <p class="text-dark-400">Erreur de chargement</p>
                    </div>
                `;
            }
        }

        // Render Video Feed
        function renderVideoFeed(videos) {
            const container = document.getElementById('feedContainer');
            
            if (!videos || videos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-video-slash text-4xl text-dark-600 mb-4"></i>
                        <p class="text-dark-400">Aucune vid√©o pour le moment</p>
                        <button onclick="showUploadModal()" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg">
                            <i class="fas fa-plus mr-2"></i> Cr√©er la premi√®re vid√©o
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = videos.map(video => `
                <div class="border-b border-dark-800">
                    <div class="container mx-auto px-4 py-6">
                        <!-- Video Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <img src="${video.avatar_url || 'https://via.placeholder.com/40'}" 
                                     class="w-10 h-10 rounded-full object-cover cursor-pointer"
                                     onclick="showUserProfile('${video.user_id}')">
                                <div>
                                    <div class="font-semibold cursor-pointer hover:underline" 
                                         onclick="showUserProfile('${video.user_id}')">
                                        @${video.username}
                                    </div>
                                    <div class="text-sm text-dark-400">
                                        ${formatTimeAgo(video.created_at)}
                                    </div>
                                </div>
                            </div>
                            <button class="w-8 h-8 rounded-full hover:bg-dark-800 flex items-center justify-center">
                                <i class="fas fa-ellipsis-h text-dark-400"></i>
                            </button>
                        </div>
                        
                        <!-- Video Player -->
                        <div class="mb-4 rounded-xl overflow-hidden">
                            <video class="w-full h-auto max-h-[600px] bg-black" 
                                   controls 
                                   poster="${video.thumbnail_url || ''}">
                                <source src="${video.video_url}" type="video/mp4">
                            </video>
                        </div>
                        
                        <!-- Video Actions -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <button onclick="toggleLike('${video.id}')" 
                                        class="flex items-center gap-2 ${video.liked_by_me ? 'text-primary' : 'text-dark-300'}">
                                    <i class="fas fa-heart ${video.liked_by_me ? 'fa-solid' : 'fa-regular'} text-xl"></i>
                                    <span>${formatCount(video.likes_count)}</span>
                                </button>
                                
                                <button onclick="showComments('${video.id}')" 
                                        class="flex items-center gap-2 text-dark-300">
                                    <i class="fas fa-comment text-xl"></i>
                                    <span>${formatCount(video.comments_count)}</span>
                                </button>
                                
                                <button onclick="shareVideo('${video.id}')" 
                                        class="flex items-center gap-2 text-dark-300">
                                    <i class="fas fa-share text-xl"></i>
                                    <span>Partager</span>
                                </button>
                            </div>
                            
                            <button onclick="saveVideo('${video.id}')" 
                                    class="text-dark-300">
                                <i class="fas fa-bookmark text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- Video Description -->
                        <div class="mb-4">
                            <p class="text-dark-300">${video.description || ''}</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${video.description ? extractHashtags(video.description).map(tag => 
                                    `<span class="text-primary cursor-pointer">${tag}</span>`
                                ).join('') : ''}
                            </div>
                        </div>
                        
                        <!-- Music Tag -->
                        <div class="flex items-center gap-2 text-dark-400 text-sm">
                            <i class="fas fa-music"></i>
                            <span>${video.music || 'Son original'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Page Navigation
        function showPage(page) {
            state.currentPage = page;
            
            // Hide all pages
            document.getElementById('feedContainer').classList.add('hidden');
            document.getElementById('explorePage').classList.add('hidden');
            document.getElementById('messagesPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            
            // Update page title
            const titles = {
                'home': 'Pour toi',
                'explore': 'Explorer',
                'messages': 'Messages',
                'profile': 'Profil'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'M&J';
            
            // Show selected page
            switch (page) {
                case 'home':
                    document.getElementById('feedContainer').classList.remove('hidden');
                    loadHomeFeed();
                    break;
                case 'explore':
                    document.getElementById('explorePage').classList.remove('hidden');
                    loadExplorePage();
                    break;
                case 'messages':
                    document.getElementById('messagesPage').classList.remove('hidden');
                    loadMessagesPage();
                    break;
                case 'profile':
                    document.getElementById('profilePage').classList.remove('hidden');
                    loadProfilePage();
                    break;
            }
        }

        // Load Explore Page
        async function loadExplorePage() {
            try {
                // Load categories
                const categories = [
                    { id: 'trending', name: 'Tendances', icon: 'üî•', color: 'from-orange-500 to-red-500' },
                    { id: 'music', name: 'Musique', icon: 'üéµ', color: 'from-blue-500 to-purple-500' },
                    { id: 'dance', name: 'Danse', icon: 'üíÉ', color: 'from-pink-500 to-rose-500' },
                    { id: 'comedy', name: 'Humour', icon: 'üòÇ', color: 'from-yellow-500 to-orange-500' },
                    { id: 'sports', name: 'Sports', icon: '‚öΩ', color: 'from-green-500 to-emerald-500' },
                    { id: 'gaming', name: 'Gaming', icon: 'üéÆ', color: 'from-purple-500 to-indigo-500' },
                    { id: 'food', name: 'Cuisine', icon: 'üçï', color: 'from-red-500 to-orange-500' },
                    { id: 'fashion', name: 'Mode', icon: 'üëó', color: 'from-pink-500 to-fuchsia-500' }
                ];
                
                const container = document.querySelector('#explorePage .grid');
                container.innerHTML = categories.map(cat => `
                    <div class="bg-gradient-to-br ${cat.color} rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transition-transform">
                        <div class="text-3xl mb-2">${cat.icon}</div>
                        <div class="font-bold">${cat.name}</div>
                    </div>
                `).join('');
                
                // Load trending videos
                const videos = await fetchWithAuth('/api/explore');
                if (videos) {
                    renderTrendingVideos(videos);
                }
            } catch (error) {
                console.error('Error loading explore page:', error);
            }
        }

        // Load Messages Page
        async function loadMessagesPage() {
            try {
                const conversations = await fetchWithAuth('/api/messages/conversations');
                if (conversations) {
                    state.conversations = conversations;
                    renderConversations(conversations);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Load Profile Page
        async function loadProfilePage() {
            if (!state.user) return;
            
            try {
                const profile = await fetchWithAuth(`/api/users/${state.user.id}`);
                if (profile) {
                    updateProfileUI(profile);
                    
                    const videos = await fetchWithAuth(`/api/users/${state.user.id}/videos`);
                    if (videos) {
                        renderProfileVideos(videos);
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Video Actions
        async function toggleLike(videoId) {
            try {
                const response = await fetchWithAuth(`/api/videos/${videoId}/like`, {
                    method: 'POST'
                });
                
                if (response) {
                    // Update UI immediately
                    const likeBtn = event.currentTarget;
                    const icon = likeBtn.querySelector('i');
                    const countSpan = likeBtn.querySelector('span');
                    
                    if (icon.classList.contains('fa-regular')) {
                        // Like
                        icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid', 'text-primary');
                        likeBtn.classList.add('text-primary');
                        countSpan.textContent = formatCount(parseInt(countSpan.textContent) + 1);
                    } else {
                        // Unlike
                        icon.classList.remove('fa-solid', 'text-primary');
                        icon.classList.add('fa-regular');
                        likeBtn.classList.remove('text-primary');
                        countSpan.textContent = formatCount(parseInt(countSpan.textContent) - 1);
                    }
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        async function showComments(videoId) {
            try {
                const comments = await fetchWithAuth(`/api/videos/${videoId}/comments`);
                if (comments) {
                    showCommentsModal(videoId, comments);
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        function shareVideo(videoId) {
            const url = `${window.location.origin}/video/${videoId}`;
            navigator.clipboard.writeText(url);
            showToast('Lien copi√© dans le presse-papier', 'success');
        }

        // Upload Modal
        function showUploadModal() {
            showToast('Fonction upload bient√¥t disponible', 'info');
        }

        // Notifications
        async function loadNotifications() {
            try {
                const notifications = await fetchWithAuth('/api/notifications');
                if (notifications) {
                    state.notifications = notifications;
                    state.unreadNotifications = notifications.filter(n => !n.is_read).length;
                    
                    if (state.unreadNotifications > 0) {
                        document.getElementById('notificationCount').classList.remove('hidden');
                        document.getElementById('notificationCount').textContent = 
                            state.unreadNotifications > 9 ? '9+' : state.unreadNotifications;
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function toggleNotifications() {
            showToast('Notifications bient√¥t disponibles', 'info');
        }

        // Search
        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.classList.toggle('hidden');
            
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('globalSearch').focus();
            }
        }

        async function performSearch(query) {
            if (query.length < 2) return;
            
            try {
                const results = await fetchWithAuth(`/api/search?q=${encodeURIComponent(query)}`);
                if (results) {
                    showSearchResults(results);
                }
            } catch (error) {
                console.error('Error searching:', error);
            }
        }

        // UI Helpers
        function showToast(message, type = 'info') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast fixed top-4 right-4 px-6 py-3 rounded-lg font-semibold z-50 animate-fade-in ${
                type === 'error' ? 'bg-red-500' :
                type === 'success' ? 'bg-green-500' :
                type === 'warning' ? 'bg-yellow-500' :
                'bg-primary'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatCount(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffDay > 0) return `Il y a ${diffDay}j`;
            if (diffHour > 0) return `Il y a ${diffHour}h`;
            if (diffMin > 0) return `Il y a ${diffMin}min`;
            return '√Ä l\'instant';
        }

        function extractHashtags(text) {
            const hashtags = text.match(/#\w+/g) || [];
            return hashtags.slice(0, 5); // Limit to 5 hashtags
        }

        function showLoadingSkeleton(containerId, count = 3) {
            const container = document.getElementById(containerId);
            container.innerHTML = Array(count).fill(0).map(() => `
                <div class="border-b border-dark-800">
                    <div class="container mx-auto px-4 py-6">
                        <!-- Skeleton Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full skeleton"></div>
                                <div>
                                    <div class="w-24 h-4 skeleton rounded mb-2"></div>
                                    <div class="w-16 h-3 skeleton rounded"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Skeleton Video -->
                        <div class="mb-4 rounded-xl overflow-hidden">
                            <div class="w-full h-[400px] skeleton"></div>
                        </div>
                        
                        <!-- Skeleton Actions -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-4 skeleton rounded"></div>
                                <div class="w-16 h-4 skeleton rounded"></div>
                                <div class="w-16 h-4 skeleton rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Event Listeners
        document.getElementById('globalSearch').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            }
        });

        // Add more event listeners as needed...

        // Initialize when page loads
        console.log('M&J Social Platform ready!');
        console.log('Server URL:', API_BASE_URL);
    </script>
</body>
</html>
