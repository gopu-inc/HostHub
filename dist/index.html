<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M&J Social</title>
    <!-- MINIMAL CSS INLINE -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000; color: white; height: 100vh; 
        }
        
        /* LOADING - disappears quickly */
        #loading { 
            position: fixed; inset: 0; background: #000; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 9999; transition: opacity 0.3s;
        }
        .loader { width: 40px; height: 40px; border: 3px solid #333; border-top-color: #FF0055; border-radius: 50%; animation: spin 1s linear infinite; }
        
        /* AUTH SCREEN - minimal */
        #auth { position: fixed; inset: 0; background: linear-gradient(135deg, #000 0%, #1a1a2e 100%); display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { max-width: 320px; width: 100%; }
        .logo { font-size: 42px; font-weight: 900; background: linear-gradient(45deg, #FF0055, #00E5FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 30px; }
        .input { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; color: white; margin-bottom: 12px; font-size: 16px; }
        .btn { width: 100%; background: #FF0055; border: none; padding: 12px; border-radius: 8px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* APP - minimal */
        #app { display: none; height: 100vh; }
        .header { position: fixed; top: 0; width: 100%; height: 50px; background: rgba(0,0,0,0.95); display: flex; align-items: center; padding: 0 15px; z-index: 100; }
        .page-title { font-size: 18px; font-weight: bold; margin-left: 10px; }
        
        /* FEED - optimized */
        .feed { padding-top: 50px; padding-bottom: 60px; }
        .video-card { margin-bottom: 1px; }
        video { width: 100%; height: 80vh; background: #000; display: block; }
        .video-info { padding: 12px; background: #111; }
        .user-info { display: flex; align-items: center; margin-bottom: 8px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; }
        
        /* NAV - minimal */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.95); display: flex; justify-content: space-around; align-items: center; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 11px; }
        .nav-btn.active { color: #FF0055; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
    <!-- FONT AWESOME CDN (async) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
</head>
<body>
    <!-- LOADING (disappears in 0.5s) -->
    <div id="loading">
        <div class="loader"></div>
    </div>

    <!-- AUTH (hidden by default) -->
    <div id="auth" style="display: none;">
        <div class="auth-box">
            <div class="logo">M&J</div>
            <input type="text" id="username" class="input" placeholder="Username" value="test">
            <input type="password" id="password" class="input" placeholder="Password" value="test123">
            <button class="btn" onclick="login()">Connexion</button>
            <div style="text-align: center; margin-top: 15px; color: #888; font-size: 14px;">
                Pas de compte ? <span onclick="showRegister()" style="color: #FF0055; cursor: pointer;">S'inscrire</span>
            </div>
        </div>
    </div>

    <!-- APP (hidden by default) -->
    <div id="app">
        <!-- HEADER -->
        <div class="header">
            <div class="logo" style="font-size: 22px;">M&J</div>
            <div class="page-title" id="pageTitle">Pour toi</div>
        </div>

        <!-- FEED -->
        <div class="feed" id="feed">
            <!-- Videos loaded here -->
        </div>

        <!-- NAVIGATION -->
        <div class="nav">
            <div class="nav-btn active" onclick="showPage('home')">
                <i class="fas fa-home"></i>
                <span>Accueil</span>
            </div>
            <div class="nav-btn" onclick="showPage('explore')">
                <i class="fas fa-compass"></i>
                <span>Explorer</span>
            </div>
            <div class="nav-btn" onclick="uploadVideo()">
                <i class="fas fa-plus" style="color: #FF0055;"></i>
                <span>Créer</span>
            </div>
            <div class="nav-btn" onclick="showPage('messages')">
                <i class="fas fa-comment"></i>
                <span>Messages</span>
            </div>
            <div class="nav-btn" onclick="showPage('profile')">
                <i class="fas fa-user"></i>
                <span>Profil</span>
            </div>
        </div>
    </div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="videoInput" accept="video/*" style="display: none;">

    <!-- ULTRA-OPTIMIZED JAVASCRIPT -->
    <script>
        // CONFIG
        const API_URL = 'https://hoosthubs-g.onrender.com';
        let token = localStorage.getItem('mj_token');
        let user = null;
        let currentPage = 'home';

        // INIT - FAST LOAD
        setTimeout(() => {
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                
                if (token) {
                    checkAuth();
                } else {
                    showAuth();
                }
            }, 300);
        }, 500); // Show loading for only 0.5s

        // CHECK AUTH QUICKLY
        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/api/users/me`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    user = await res.json();
                    showApp();
                    loadFeedFast();
                } else {
                    showAuth();
                }
            } catch {
                showAuth();
            }
        }

        // SHOW AUTH SCREEN
        function showAuth() {
            document.getElementById('auth').style.display = 'flex';
        }

        // LOGIN
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            
            try {
                const res = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('mj_token', token);
                    location.reload(); // Fast reload
                } else {
                    alert(data.detail || 'Erreur');
                }
            } catch {
                alert('Erreur réseau');
            }
        }

        // SHOW APP
        function showApp() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        // LOAD FEED FAST
        async function loadFeedFast() {
            try {
                const res = await fetch(`${API_URL}/api/videos/feed`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const videos = await res.json();
                renderFeed(videos);
            } catch (e) {
                document.getElementById('feed').innerHTML = '<div style="padding: 50px; text-align: center; color: #888;">Erreur de chargement</div>';
            }
        }

        // RENDER FEED EFFICIENTLY
        function renderFeed(videos) {
            const feed = document.getElementById('feed');
            
            if (!videos || videos.length === 0) {
                feed.innerHTML = '<div style="padding: 50px; text-align: center; color: #888;">Aucune vidéo</div>';
                return;
            }
            
            let html = '';
            for (let video of videos.slice(0, 10)) { // Limit to 10 videos for speed
                html += `
                    <div class="video-card">
                        <video controls poster="${video.thumbnail_url || ''}">
                            <source src="${video.video_url}" type="video/mp4">
                        </video>
                        <div class="video-info">
                            <div class="user-info">
                                <img src="${video.avatar_url}" class="avatar">
                                <div>
                                    <div style="font-weight: bold;">@${video.username}</div>
                                    <div style="font-size: 12px; color: #888;">${formatTime(video.created_at)}</div>
                                </div>
                            </div>
                            <p style="margin-bottom: 10px; font-size: 14px;">${video.description?.substring(0, 100) || ''}</p>
                            <div style="display: flex; gap: 20px;">
                                <button onclick="likeVideo('${video.id}')" style="background: none; border: none; color: ${video.liked_by_me ? '#FF0055' : 'white'};">
                                    <i class="fas fa-heart"></i> ${video.likes_count}
                                </button>
                                <button onclick="commentVideo('${video.id}')" style="background: none; border: none; color: white;">
                                    <i class="fas fa-comment"></i> ${video.comments_count}
                                </button>
                                <button onclick="shareVideo('${video.id}')" style="background: none; border: none; color: white;">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            feed.innerHTML = html;
        }

        // VIDEO ACTIONS
        async function likeVideo(videoId) {
            try {
                await fetch(`${API_URL}/api/videos/${videoId}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                // Update UI immediately
                const btn = event.target.closest('button');
                const icon = btn.querySelector('i');
                const count = btn.querySelector('span');
                
                if (icon.style.color === 'rgb(255, 0, 85)') {
                    icon.style.color = 'white';
                    count.textContent = parseInt(count.textContent) - 1;
                } else {
                    icon.style.color = '#FF0055';
                    count.textContent = parseInt(count.textContent) + 1;
                }
            } catch (e) {
                console.error('Like error:', e);
            }
        }

        function commentVideo(videoId) {
            const text = prompt('Votre commentaire:');
            if (!text) return;
            
            fetch(`${API_URL}/api/videos/${videoId}/comments`, {
                method: 'POST',
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text })
            }).then(() => {
                alert('Commentaire ajouté!');
            }).catch(() => {
                alert('Erreur');
            });
        }

        function shareVideo(videoId) {
            const url = `${window.location.origin}/video/${videoId}`;
            navigator.clipboard.writeText(url);
            alert('Lien copié!');
        }

        // PAGE NAVIGATION
        function showPage(page) {
            currentPage = page;
            document.getElementById('pageTitle').textContent = 
                page === 'home' ? 'Pour toi' :
                page === 'explore' ? 'Explorer' :
                page === 'messages' ? 'Messages' : 'Profil';
            
            // Simple page switching
            if (page === 'home') {
                loadFeedFast();
            } else if (page === 'explore') {
                document.getElementById('feed').innerHTML = '<div style="padding: 50px; text-align: center;">Explorer - À venir</div>';
            } else if (page === 'messages') {
                document.getElementById('feed').innerHTML = '<div style="padding: 50px; text-align: center;">Messages - À venir</div>';
            } else if (page === 'profile') {
                loadProfile();
            }
            
            // Update nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');
        }

        // LOAD PROFILE
        async function loadProfile() {
            if (!user) return;
            
            try {
                const res = await fetch(`${API_URL}/api/users/${user.id}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const profile = await res.json();
                
                const html = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img src="${profile.avatar_url}" style="width: 80px; height: 80px; border-radius: 50%;">
                            <h2 style="margin-top: 10px;">@${profile.username}</h2>
                            <p style="color: #888; margin: 10px 0;">${profile.bio || ''}</p>
                            <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                                <div>
                                    <div style="font-weight: bold;">${profile.videos_count || 0}</div>
                                    <div style="font-size: 12px; color: #888;">Vidéos</div>
                                </div>
                                <div>
                                    <div style="font-weight: bold;">${profile.followers_count || 0}</div>
                                    <div style="font-size: 12px; color: #888;">Abonnés</div>
                                </div>
                                <div>
                                    <div style="font-weight: bold;">${profile.following_count || 0}</div>
                                    <div style="font-size: 12px; color: #888;">Abonnements</div>
                                </div>
                            </div>
                        </div>
                        <div style="color: #888; text-align: center;">Vidéos à venir...</div>
                    </div>
                `;
                document.getElementById('feed').innerHTML = html;
            } catch (e) {
                document.getElementById('feed').innerHTML = '<div style="padding: 50px; text-align: center; color: #888;">Erreur profil</div>';
            }
        }

        // UPLOAD VIDEO
        function uploadVideo() {
            document.getElementById('videoInput').click();
        }

        document.getElementById('videoInput').onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const description = prompt('Description:') || '';
            
            const formData = new FormData();
            formData.append('video', file);
            formData.append('description', description);
            
            try {
                const res = await fetch(`${API_URL}/api/videos/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                
                if (res.ok) {
                    alert('Vidéo publiée!');
                    loadFeedFast();
                } else {
                    alert('Erreur upload');
                }
            } catch {
                alert('Erreur réseau');
            }
        };

        // UTILITY FUNCTIONS
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days > 0) return `${days}j`;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            if (hours > 0) return `${hours}h`;
            
            const mins = Math.floor(diff / (1000 * 60));
            return mins > 0 ? `${mins}min` : 'Maintenant';
        }

        function showRegister() {
            const username = prompt('Nouveau username:');
            const password = prompt('Nouveau password:');
            
            if (!username || !password) return;
            
            fetch(`${API_URL}/api/users/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }).then(res => res.json())
              .then(data => {
                  if (data.access_token) {
                      localStorage.setItem('mj_token', data.access_token);
                      location.reload();
                  } else {
                      alert('Erreur inscription');
                  }
              }).catch(() => {
                  alert('Erreur réseau');
              });
        }
    </script>
</body>
</html>
